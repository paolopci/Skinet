<div class="mt-32 flex flex-col gap-8 lg:flex-row">
    <div class="lg:w-3/4">
        <mat-stepper #stepper class="bg-white border border-gray-200 shodow-sm"
            (selectionChange)="onStepChange($event)">
            <mat-step label="Address">
                <div id="address-element"></div>
                <div class="mt-6 flex flex-col gap-4">
                    <div class="flex justify-end">
                        <mat-checkbox [checked]="saveAddress" [disabled]="isProceedingToShipping"
                            (change)="onSaveAddressCheckboxChange($event)">
                            Save as default address
                        </mat-checkbox>
                    </div>
                    <div class="flex items-center justify-between">
                        <button routerLink="/shop" mat-stroked-button>Continue shopping</button>
                        <button mat-flat-button [disabled]="isProceedingToShipping" (click)="goToShipping(stepper)">
                            {{ isProceedingToShipping ? 'Saving...' : 'Next' }}
                        </button>
                    </div>
                </div>
            </mat-step>

            <mat-step label="Shipping">
                <app-checkout-delivery></app-checkout-delivery>
                <div class="flex justify-between mt-6">
                    <button mat-stroked-button [disabled]="isReturningToAddress" (click)="goBackToAddress(stepper)">
                        {{ isReturningToAddress ? 'Loading address...' : 'Back' }}
                    </button>
                    <button mat-flat-button matStepperNext [disabled]="!checkoutService.selectedDeliveryMethod()">Next</button>
                </div>
            </mat-step>
            <mat-step label="Payment">
                <div class="mb-4 rounded-md border border-slate-200 bg-slate-50 p-3">
                    <mat-checkbox [checked]="savePaymentMethod" [disabled]="!!selectedSavedPaymentMethodId || isProcessingPayment"
                        (change)="onSavePaymentMethodCheckboxChange($event)">
                        Salva carta per i prossimi acquisti
                    </mat-checkbox>
                </div>

                @if (isLoadingSavedPaymentMethods) {
                <div class="mb-4 rounded-md border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">
                    Caricamento carte salvate...
                </div>
                } @else if (savedPaymentMethods.length > 0) {
                <div class="mb-4 rounded-md border border-slate-200 bg-white p-4">
                    <p class="mb-2 text-sm font-semibold text-slate-700">Carte salvate</p>
                    <div class="flex flex-col gap-2">
                        @for (method of savedPaymentMethods; track method.id) {
                        <button type="button" mat-stroked-button class="justify-start"
                            [disabled]="isProcessingPayment"
                            [class.border-emerald-400]="selectedSavedPaymentMethodId === method.id"
                            (click)="onSelectSavedPaymentMethod(method.id)">
                            {{ method.brand }} •••• {{ method.last4 }} ({{ method.expMonth }}/{{ method.expYear }})
                            @if (method.isDefault) { <span class="ml-2 text-emerald-700">(default)</span> }
                        </button>
                        }
                        <button type="button" mat-button [disabled]="isProcessingPayment"
                            (click)="onUseNewCard()">
                            Usa una nuova carta
                        </button>
                    </div>
                </div>
                }

                @if (isLoadingPaymentElement) {
                <div class="rounded-md border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">
                    Caricamento metodi di pagamento...
                </div>
                }
                @if (!selectedSavedPaymentMethodId) {
                <div id="payment-element" class="min-h-24"></div>
                } @else {
                <div class="rounded-md border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-700">
                    Metodo salvato selezionato: non è necessario reinserire i dati carta.
                </div>
                }
                @if (paymentElementError) {
                <div class="mt-3 flex items-center justify-between gap-3 rounded-md border border-red-200 bg-red-50 p-3">
                    <p class="text-sm text-red-700">{{ paymentElementError }}</p>
                    <button mat-stroked-button type="button" (click)="retryPaymentElementLoad()"
                        [disabled]="isLoadingPaymentElement || isProcessingPayment">
                        Riprova
                    </button>
                </div>
                }
                <div class="flex justify-between mt-6">
                    <button mat-stroked-button [disabled]="isProcessingPayment" matStepperPrevious>Back</button>
                    <button mat-flat-button
                        [disabled]="isLoadingPaymentElement || isProcessingPayment || (!selectedSavedPaymentMethodId && (!isPaymentElementReady || !isPaymentElementComplete))"
                        (click)="proceedToConfirmation(stepper)">
                        {{ isProcessingPayment ? 'Processing...' : 'Next' }}
                    </button>
                </div>
            </mat-step>
            <mat-step label="Confirmation">
                @if (isOrderConfirmed) {
                <div class="rounded-md border border-emerald-200 bg-emerald-50 p-4 text-emerald-700">
                    <p class="font-semibold">Pagamento confermato.</p>
                    @if (confirmedOrderId) {
                    <p class="mt-1 text-sm">Ordine #{{ confirmedOrderId }} registrato correttamente.</p>
                    }
                    @if (confirmationMessage) {
                    <p class="mt-1 text-sm">{{ confirmationMessage }}</p>
                    }
                </div>
                } @else {
                <div class="rounded-md border border-amber-200 bg-amber-50 p-4 text-amber-700 text-sm">
                    Step di conferma disponibile solo dopo finalizzazione pagamento lato server.
                </div>
                }
            </mat-step>
        </mat-stepper>
    </div>
    <div class="px-3 lg:w-1/4 lg:px-0">
        <app-order-summary [subtotal]="subtotal()" [discount]="discount()" [shippingCost]="shippingCost()"
            [orderTotal]="orderTotal()" [showCheckoutCta]="false"></app-order-summary>
    </div>
</div>
