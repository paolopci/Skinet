{
  "info": {
    "name": "Skinet-Identity",
    "description": "Collection per test endpoint Identity/API account.\n\nCome eseguire:\n1) Imposta la variabile baseUrl nell'environment.\n2) Esegui le request Account in ordine numerico (1 -> 13).\n3) La login (step 2) salva authToken, usato dagli step protetti.\n4) Gli step address (5 e 6) usano il nuovo schema internazionale.\n5) Gli step reset/verify richiedono token prodotti dagli endpoint precedenti.\n\nNota: se esegui singole request fuori sequenza, alcuni test possono fallire per dipendenze mancanti (token/utente).",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "AccountController",
      "description": "Eseguire le request in ordine numerico (1 -> 13). Le request protette richiedono authToken ottenuto allo step 2.",
      "item": [
        {
          "name": "Account - 1 register",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"{{firstName}}\",\n  \"lastName\": \"{{lastName}}\",\n  \"email\": \"{{userEmail}}\",\n  \"password\": \"{{userPassword}}\",\n  \"confirmPassword\": \"{{userPassword}}\",\n  \"phoneNumber\": \"{{phoneNumber}}\",\n  \"address\": {\n    \"firstName\": \"{{firstName}}\",\n    \"lastName\": \"{{lastName}}\",\n    \"addressLine1\": \"{{addressLine1}}\",\n    \"addressLine2\": \"{{addressLine2}}\",\n    \"city\": \"{{city}}\",\n    \"postalCode\": \"{{postalCode}}\",\n    \"countryCode\": \"{{countryCode}}\",\n    \"region\": \"{{region}}\"\n  }\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": "{{baseUrl}}/api/account/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 201/400\", function () {",
                  "  pm.expect([201, 400]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 201) {",
                  "  const data = pm.response.json();",
                  "  pm.test(\"Register ritorna campi utente\", function () {",
                  "    pm.expect(data.email).to.eql(pm.variables.get(\"userEmail\"));",
                  "    pm.expect(data.firstName).to.eql(pm.variables.get(\"firstName\"));",
                  "    pm.expect(data.lastName).to.eql(pm.variables.get(\"lastName\"));",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 2 login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\",\n  \"password\": \"{{userPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": "{{baseUrl}}/api/account/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/401\", function () {",
                  "  pm.expect([200, 401]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const data = pm.response.json();",
                  "  pm.test(\"Login ritorna token\", function () {",
                  "    pm.expect(data.token).to.be.a(\"string\").and.not.empty;",
                  "  });",
                  "  pm.collectionVariables.set(\"authToken\", data.token);",
                  "  pm.collectionVariables.set(\"loggedInEmail\", data.email);",
                  "} else {",
                  "  pm.collectionVariables.unset(\"authToken\");",
                  "  pm.collectionVariables.unset(\"loggedInEmail\");",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 3 login bad password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\",\n  \"password\": \"{{badPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": "{{baseUrl}}/api/account/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 401\", function () {",
                  "  pm.expect([401]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 4 current-user",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/account/current-user"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/401\", function () {",
                  "  pm.expect([200, 401]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const data = pm.response.json();",
                  "  const expectedEmail = pm.collectionVariables.get(\"loggedInEmail\") || pm.variables.get(\"userEmail\");",
                  "  pm.test(\"Current-user ritorna campi utente\", function () {",
                  "    pm.expect(data.email).to.eql(expectedEmail);",
                  "    pm.expect(data.firstName).to.eql(pm.variables.get(\"firstName\"));",
                  "    pm.expect(data.lastName).to.eql(pm.variables.get(\"lastName\"));",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 5 get address",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/account/address"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/401/404\", function () {",
                  "  pm.expect([200, 401, 404]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const data = pm.response.json();",
                  "  pm.test(\"Address ritorna campi\", function () {",
                  "    pm.expect(data.firstName).to.be.a(\"string\");",
                  "    pm.expect(data.lastName).to.be.a(\"string\");",
                  "    pm.expect(data.addressLine1).to.be.a(\"string\");",
                  "    pm.expect(data.countryCode).to.be.a(\"string\");",
                  "    pm.expect(data.city).to.be.a(\"string\");",
                  "    pm.expect(data.region).to.be.a(\"string\");",
                  "    pm.expect(data.postalCode).to.be.a(\"string\");",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 6 update address",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/account/address",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"{{firstName}}\",\n  \"lastName\": \"{{lastName}}\",\n  \"addressLine1\": \"{{addressLine1}}\",\n  \"addressLine2\": \"{{addressLine2}}\",\n  \"city\": \"{{city}}\",\n  \"postalCode\": \"{{postalCode}}\",\n  \"countryCode\": \"{{countryCode}}\",\n  \"region\": \"{{region}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/400/401\", function () {",
                  "  pm.expect([200, 400, 401]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const data = pm.response.json();",
                  "  pm.test(\"Update address ritorna campi\", function () {",
                  "    pm.expect(data.firstName).to.eql(pm.variables.get(\"firstName\"));",
                  "    pm.expect(data.lastName).to.eql(pm.variables.get(\"lastName\"));",
                  "    pm.expect(data.addressLine1).to.eql(pm.variables.get(\"addressLine1\"));",
                  "    pm.expect(data.countryCode).to.eql(pm.variables.get(\"countryCode\"));",
                  "    pm.expect(data.city).to.eql(pm.variables.get(\"city\"));",
                  "    pm.expect(data.region).to.eql(pm.variables.get(\"region\"));",
                  "    pm.expect(data.postalCode).to.eql(pm.variables.get(\"postalCode\"));",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 7 forgot-password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/account/forgot-password",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200\", function () {",
                  "  pm.expect(pm.response.code).to.eql(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test(\"Messaggio coerente\", function () {",
                  "  pm.expect(body.message).to.include(\"Se l'email esiste\");",
                  "});",
                  "if (body.token) {",
                  "  pm.collectionVariables.set(\"resetToken\", body.token);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 8 reset-password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/account/reset-password",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\",\n  \"token\": \"{{resetToken}}\",\n  \"newPassword\": \"{{newPassword}}\",\n  \"confirmPassword\": \"{{newPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/400\", function () {",
                  "  pm.expect([200, 400]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  const body = pm.response.json();",
                  "  pm.test(\"Messaggio ok\", function () {",
                  "    pm.expect(body.message).to.include(\"Password aggiornata\");",
                  "  });",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 9 change-password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/account/change-password",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"currentPassword\": \"{{userPassword}}\",\n  \"newPassword\": \"{{newPassword}}\",\n  \"confirmPassword\": \"{{newPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/400/401\", function () {",
                  "  pm.expect([200, 400, 401]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code === 200) {",
                  "  pm.collectionVariables.set(\"userPassword\", pm.collectionVariables.get(\"newPassword\"));",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 10 verify-email",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/account/verify-email",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\",\n  \"token\": \"{{verifyToken}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/400\", function () {",
                  "  pm.expect([200, 400]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 11 send-verify-email",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": "{{baseUrl}}/api/account/send-verify-email"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200\", function () {",
                  "  pm.expect(pm.response.code).to.eql(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test(\"Messaggio coerente\", function () {",
                  "  pm.expect(body.message).to.include(\"Se l'email esiste\");",
                  "});",
                  "if (body.token) {",
                  "  pm.collectionVariables.set(\"verifyToken\", body.token);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 12 refresh",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/api/account/refresh"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/401\", function () {",
                  "  pm.expect([200, 401]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Account - 13 logout",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/api/account/logout"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/204/401\", function () {",
                  "  pm.expect([200, 204, 401]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ],
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const now = new Date();",
              "const pad = (n) => String(n).padStart(2, '0');",
              "const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;",
              "if (!pm.environment.get('userEmail')) {",
              "  const unique = `test_${stamp}_${Math.random().toString(36).slice(2,8)}@example.com`;",
              "  pm.environment.set('userEmail', unique);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "Dev",
      "description": "Utility per ambiente Development: reset identity, login admin e verifica ruolo Admin.",
      "item": [
        {
          "name": "Dev - 1 reset identity",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/dev/reset-identity"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200/404\", function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});",
                  "if (pm.response.code !== 200) {",
                  "  return;",
                  "}",
                  "const body = pm.response.json();",
                  "pm.test('Reset identity messaggio ok', function () {",
                  "  pm.expect(body.message).to.include('Identity reset completato');",
                  "});",
                  "pm.test('Admin creato', function () {",
                  "  pm.expect(body.adminEmail).to.eql('paolopci@yahoo.it');",
                  "});",
                  "pm.test('Utenti standard creati', function () {",
                  "  pm.expect(body.users).to.be.an('array');",
                  "  pm.expect(body.users).to.include('gigi@yahoo.it');",
                  "  pm.expect(body.users).to.include('carlo@yahoo.it');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Dev - 2 login admin",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            },
            "url": "{{baseUrl}}/api/account/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200\", function () {",
                  "  pm.expect(pm.response.code).to.eql(200);",
                  "});",
                  "const data = pm.response.json();",
                  "pm.test(\"Login admin ritorna token\", function () {",
                  "  pm.expect(data.token).to.be.a(\"string\").and.not.empty;",
                  "});",
                  "pm.collectionVariables.set(\"authToken\", data.token);"
                ]
              }
            }
          ]
        },
        {
          "name": "Dev - 3 admin check",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{authToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/dev/admin-check"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test(\"Status 200\", function () {",
                  "  pm.expect(pm.response.code).to.eql(200);",
                  "});",
                  "const body = pm.response.json();",
                  "pm.test(\"Admin access ok\", function () {",
                  "  pm.expect(body.message).to.include('Admin access ok');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "https://localhost:5001"
    },
    {
      "key": "firstName",
      "value": "Test"
    },
    {
      "key": "lastName",
      "value": "User"
    },
    {
      "key": "userEmail",
      "value": "test.user@skinet.local"
    },
    {
      "key": "userPassword",
      "value": "Test1234!"
    },
    {
      "key": "adminEmail",
      "value": "paolopci@yahoo.it"
    },
    {
      "key": "adminPassword",
      "value": "Micene@65"
    },
    {
      "key": "badPassword",
      "value": "Wrong123!"
    },
    {
      "key": "authToken",
      "value": ""
    },
    {
      "key": "phoneNumber",
      "value": "+393331112233"
    },
    {
      "key": "addressLine1",
      "value": "Via Roma 10"
    },
    {
      "key": "addressLine2",
      "value": "Scala A"
    },
    {
      "key": "city",
      "value": "Milano"
    },
    {
      "key": "countryCode",
      "value": "IT"
    },
    {
      "key": "region",
      "value": "MI"
    },
    {
      "key": "postalCode",
      "value": "20100"
    },
    {
      "key": "resetToken",
      "value": ""
    },
    {
      "key": "verifyToken",
      "value": ""
    },
    {
      "key": "newPassword",
      "value": "Test12345!"
    }
  ]
}
